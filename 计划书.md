### ğŸ¯ ç›®æ ‡  
åœ¨ **ä¸å¤§å¹… refactor** çš„å‰æä¸‹ï¼Œè§£å†³ä»¥ä¸‹æ ¸å¿ƒç—›ç‚¹ï¼š  

1. **æˆæƒæ··ç”¨** å¯¼è‡´ refresh token å§‹ç»ˆä¸ºç©ºã€401 å¾ªç¯é€€å‡ºã€‚  
2. **client secret æš´éœ²** ä¸ Spotify Mobile SDK æ”¿ç­–å†²çªã€‚  
3. å®šæ—¶åˆ·æ–°ã€è¿æ¥ç›‘å¬çš„ç«äº‰æ¡ä»¶å¯¼è‡´ã€Œå‡æ‰çº¿ï¼å¤šé‡è®¢é˜…ã€ã€‚  

æœ€ç»ˆè¾¾åˆ°â€”â€”  
* App èƒ½åœ¨ Android çœŸæœºä¸Šç¨³å®šç™»å½•ã€è·å–æ’­æ”¾çŠ¶æ€ï¼Œtoken è¿‡æœŸåè‡ªåŠ¨å¼¹å‡ºä¸€æ¬¡ç™»å½•é‡æ–°æˆæƒã€‚  
* ä¸å†æŠŠ `clientSecret` å†™è¿› APKï¼Œä¹Ÿä¸å†ä¾èµ– `flutter_appauth`ã€‚  
* ä»£ç æ”¹åŠ¨å°½é‡é›†ä¸­ï¼ŒProvider å±‚æ¥å£ **ä¸å˜**ï¼ŒUI æ— æ„ŸçŸ¥ã€‚  

---

## ğŸ› â€‚æœ€å°æ”¹åŠ¨ç­–ç•¥  

| ç»„ä»¶ | åŠ¨ä½œ | è¯´æ˜ |
|------|------|------|
| **Auth æ–¹æ¡ˆ** | **ä»…ä¿ç•™ `spotify_sdk` éšå¼ PKCE** | ç§»é™¤æ‰€æœ‰ `flutter_appauth` & `clientSecret` ç›¸å…³é€»è¾‘ã€‚æ— éœ€åˆ·æ–°ä»¤ç‰Œï¼Œå¤±æ•ˆæ—¶é‡æ–°è°ƒ `getAccessToken()`ã€‚ |
| **å­˜å‚¨** | åªå­˜ `access_token` & `expires_at` | `refresh_token` å­—æ®µç•™ç©ºå³å¯ã€‚ |
| **Token æ£€æŸ¥** | `isAuthenticated()` åˆ¤è¿‡æœŸç›´æ¥è¿”å› `false` | äº¤ç”±ä¸Šå±‚æ•è·åè°ƒç”¨ `login()`ï¼Œè€Œä¸æ˜¯å†…éƒ¨å¼ºåˆ·ã€‚ |
| **è¿æ¥ç›‘å¬** | ç›‘å¬é€»è¾‘åªä¿ç•™ä¸€å¤„ï¼ˆAuthServiceï¼‰ | Provider ä¸å†å•ç‹¬è®¢é˜…ã€‚ |
| **é…ç½®** | `clientId` å†™æ­»æˆ–èµ° SecureStorageï¼›**åˆ é™¤ clientSecret** | `SpotifyDashboard` ä»…éœ€å¡« redirect URIã€‚ |
| **Scope** | ç²¾ç®€ä¸ºæ’­æ”¾æ§åˆ¶ + åº“è®¿é—® | åˆ é™¤ `app-remote-control`ï¼ˆå¦‚æœæš‚ä¸ä½¿ç”¨ Remote åŠŸèƒ½ï¼Œå¯ä¸€èµ·åˆ ï¼‰ã€‚ |

---

## ğŸ“‘â€‚è¯¦ç»†ä»»åŠ¡æ¸…å•  

> **è¡Œå·å‚è€ƒ**ï¼ä½ å½“å‰ä»“åº“é‡Œçš„è¡Œå·ï¼Œå¯èƒ½éœ€æ ¹æ® IDE æœç´¢å…³é”®è¯å®šä½ã€‚  

| # | æ–‡ä»¶ / å‡½æ•° | æ”¹åŠ¨è¯´æ˜ | å…³é”®ä»£ç ç‰‡æ®µ |
|---|-------------|----------|--------------|
| 1 | **`spotify_service.dart`**<br>`SpotifyAuthService` æ„é€ å‡½æ•° | **å»æ‰ `clientSecret` å‚æ•°**ï¼›åˆ é™¤æ‰€æœ‰å†™å…¥/è¯»å– `_refreshTokenKey` çš„è¯­å¥ã€‚ | ```dart<br>SpotifyAuthService({required this.clientId, required this.redirectUrl, ...});``` |
| 2 | åŒæ–‡ä»¶<br>`defaultScopes` | å¯ä¿ç•™ï¼š`user-read-email user-read-playback-state user-modify-playback-state user-library-read user-library-modify`<br>æš‚æ—¶ **ç§»é™¤ `app-remote-control`**ã€‚ | |
| 3 | åŒæ–‡ä»¶<br>`login()` | - åˆ é™¤ `flutter_appauth` åˆ†æ”¯ã€‚<br>- ä¿ç•™ `SpotifySdk.getAccessToken()` è·¯å¾„ã€‚<br>- æˆåŠŸåï¼š`_saveAuthResponse(token, expiresAtNowPlus60m)`ã€‚ | ```dart<br>final token = await SpotifySdk.getAccessToken(...);<br>final expiresAt = DateTime.now().add(const Duration(hours:1));<br>await _saveAuthResponse(token, expiresAt);``` |
| 4 | åŒæ–‡ä»¶<br>`isAuthenticated()` | ç®€åŒ–é€»è¾‘ï¼šè‹¥ `expires_at` < `DateTime.now()` ç›´æ¥ `return false;`ï¼ˆ**ä¸è¦**è‡ªåŠ¨åˆ·æ–°ï¼‰ã€‚ | |
| 5 | åŒæ–‡ä»¶<br>`refreshToken()` | é‡å‘½åä¸º `getNewToken()` æˆ–ç›´æ¥ **åˆ é™¤æ•´æ®µ**ï¼›Provider ä¸å†è°ƒç”¨ã€‚ | |
| 6 | åŒæ–‡ä»¶<br>`_saveAuthResponse()` | ä¿ç•™ `access_token / expires_at`ï¼Œ**ä¸ä¿å­˜ refresh_token**ã€‚ | |
| 7 | åŒæ–‡ä»¶<br>æ‰€æœ‰å¼•ç”¨ `_refreshTokenKey` çš„ä½ç½® | ç»Ÿä¸€åˆ é™¤ã€‚ | |
| 8 | **`spotify_provider.dart`**<br>`_initSpotifyService()` | æ„é€  `SpotifyAuthService` æ—¶ **å»æ‰ clientSecret**ã€‚ | |
| 9 | åŒæ–‡ä»¶<br>`setClientCredentials()` / `resetClientCredentials()` | åªæŒä¹…åŒ–/åˆ é™¤ `clientId`ï¼Œä¸å†æ¶‰åŠ `clientSecret`ã€‚ | |
| 10 | åŒæ–‡ä»¶<br>`autoLogin()` & `login()` | - æ•è· `isAuthenticated()==false` â†’ è°ƒ `login()`ã€‚<br>- å»æ‰ `refreshToken()` çš„è°ƒç”¨ã€‚ | |
| 11 | **è¿æ¥ç›‘å¬**<br>`SpotifyProvider._setupConnectionListener()` | **åˆ é™¤æ•´å‡½æ•°åŠè°ƒç”¨**ï¼›æ”¹åœ¨ `SpotifyAuthService._setupConnectionListener()` å†…è§¦å‘ `onConnected/onDisconnected` å›è°ƒï¼ˆå·²å­˜åœ¨ï¼‰ã€‚ | |
| 12 | **`pubspec.yaml`** | ç§»é™¤ `flutter_appauth` ä¾èµ–ã€‚ç¡®ä¿ `spotify_sdk` ç‰ˆæœ¬ â‰¥ 2.4.1ã€‚ | |
| 13 | **Android é¡¹ç›®**<br>`AndroidManifest.xml` | ä¿ç•™ `intent-filter`ï¼š`<data android:scheme="spotoolfy" android:host="callback" />`ã€‚ç¡®ä¿ä¸ Spotify Dashboard redirect URI åŒ¹é…ã€‚ | |
| 14 | **iOS (å¯é€‰)**<br>`Info.plist` | é…ç½® `LSApplicationQueriesSchemes` ä¸­åŒ…å« `spotify`ï¼›æ–°å¢ URL Scheme `spotoolfy`. | |

---

## âœ…â€‚éªŒæ”¶æ ‡å‡†  

1. **é¦–æ¬¡ç™»å½•**  
   * ç‚¹å‡»ã€Œç™»å½• Spotifyã€â†’ å¼¹å‡ºå®˜æ–¹æˆæƒé¡µ â†’ åŒæ„åè¿”å› Appã€‚  
   * æ§åˆ¶å°æ‰“å° **`Logged in as: <username>`**ï¼›`token` å†™å…¥ SecureStorageã€‚  
2. **Token å¤±æ•ˆ**ï¼ˆå¯æ‰‹åŠ¨å°†ç³»ç»Ÿæ—¶é—´æ‹¨å¿« 2h éªŒè¯ï¼‰ï¼š  
   * ä¸‹æ¬¡è®¿é—® Web API è¿”å› 401 â†’ `isAuthenticated()` åˆ¤å®šä¸º `false` â†’ UI è‡ªåŠ¨å†å¼¹æˆæƒé¡µã€‚  
   * é‡æ–°æˆæƒååŠŸèƒ½æ¢å¤ï¼Œæ— å´©æºƒã€‚  
3. **APK å®‰å…¨å®¡è®¡**  
   * ç”¨è§£åŒ…å·¥å…·æ‰«æ `.so / .dex`ï¼Œ**ä¸å‡ºç°æ˜æ–‡ `clientSecret` å­—ç¬¦ä¸²**ã€‚  
4. **è¿æ¥ç›‘å¬**  
   * è¿ç»­é”å±/è§£é”æˆ–æ€æ‰ Spotify App åï¼Œå†è¿”å›ä½ çš„ App ä¸ä¼šå‡ºç°å¤šæ¬¡ `subscribeConnectionStatus()` æŠ¥é”™ã€‚  

---

## â±â€‚é¢„ä¼°å·¥æ—¶  

| ä»»åŠ¡ | å·¥æ—¶ |
|------|------|
| ä»£ç åˆ é™¤/ä¿®æ”¹ & æœ¬åœ°ç¼–è¯‘ | 1 h |
| Android å®æœºæµ‹è¯•ï¼ˆé¦–æ¬¡ç™»å½•ï¼‹è¿‡æœŸæ¨¡æ‹Ÿï¼‰ | 1 h |
| iOS é€‚é…ï¼ˆå¦‚éœ€ï¼‰ | 1 h |
| æ–‡æ¡£ / README æ›´æ–° | 0.5 h |
| **æ€»è®¡** | **â‰ˆ 3.5 h** |

---

## ğŸ“Œâ€‚åç»­å±•æœ›ï¼ˆå¯é€‰ï¼‰  

* è‹¥åç»­éœ€è¦ **åå°é™é»˜åˆ·æ–° + é•¿æ—¶é—´æ’­æ”¾**ï¼Œå†è€ƒè™‘æŠŠ OAuth æµç¨‹è¿åˆ°åç«¯æˆ–æ”¹ä¸º **Authorization-Code PKCE**ã€‚  
* å¼•å…¥ `spotify_player` æˆ– `audio_service` å¯åœ¨å‰å°/åå°éŸ³é¢‘ä½“éªŒä¸Šè·å¾—æ›´å¤šæ§åˆ¶æƒã€‚